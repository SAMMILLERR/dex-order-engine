<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEX Order Engine - Professional Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.7;
        }

        /* Feature Badges */
        .features-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .feature-badge {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .panel h2 {
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.5rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Control Panel */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        select, input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            color: #e0e0e0;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.08);
        }

        select option {
            background: #1a1a2e;
            color: #e0e0e0;
        }

        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        .quick-amounts button {
            padding: 8px;
            border: 1px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .quick-amounts button:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-concurrent {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-top: 10px;
        }

        .btn-concurrent:hover:not(:disabled) {
            box-shadow: 0 6px 25px rgba(245, 87, 108, 0.5);
        }

        /* Order Timeline */
        .order-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .order-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #667eea;
        }

        .order-card.confirmed::before {
            background: #4caf50;
        }

        .order-card.failed::before {
            background: #f44336;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .order-id {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
        }

        .order-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .status-routing { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
        .status-building { background: rgba(156, 39, 176, 0.2); color: #9c27b0; }
        .status-submitted { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
        .status-confirmed { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-failed { background: rgba(244, 67, 54, 0.2); color: #f44336; }

        .order-stages {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .stage {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }

        .stage.active {
            background: #667eea;
            animation: glow 1.5s infinite;
        }

        .stage.completed {
            background: #4caf50;
        }

        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            font-size: 0.9rem;
        }

        .detail-item {
            color: #b0b0b0;
        }

        .detail-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        /* Statistics Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #b0b0b0;
            text-transform: uppercase;
        }

        /* Console Log */
        .console-log {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            display: flex;
            gap: 10px;
        }

        .log-time {
            color: #666;
            flex-shrink: 0;
        }

        .log-info { background: rgba(33, 150, 243, 0.1); color: #2196f3; }
        .log-success { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
        .log-warning { background: rgba(255, 193, 7, 0.1); color: #ffc107; }
        .log-error { background: rgba(244, 67, 54, 0.1); color: #f44336; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .bottom-section {
                grid-template-columns: 1fr;
            }
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 6px 12px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üöÄ DEX Order Execution Engine</h1>
            <p>Real-time Market Orders with Multi-DEX Routing & WebSocket Status Updates</p>
            <div style="margin-top: 15px;">
                <span class="connection-status">
                    <span class="connection-dot"></span>
                    Connected to: <span id="apiUrl">https://dex-order-engine-7jt2.onrender.com</span>
                </span>
            </div>
        </div>

        <!-- Features Bar -->
        <div class="features-bar">
            <div class="feature-badge">‚úÖ Concurrent Processing (10 workers)</div>
            <div class="feature-badge">‚úÖ WebSocket Live Updates</div>
            <div class="feature-badge">‚úÖ DEX Routing (Raydium & Meteora)</div>
            <div class="feature-badge">‚úÖ Automatic Retry Logic</div>
            <div class="feature-badge">‚úÖ Redis Queue (BullMQ)</div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="successRate">100%</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgExecTime">0.0s</div>
                <div class="stat-label">Avg Execution Time</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeOrders">0</div>
                <div class="stat-label">Active Orders</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Control Panel -->
            <div class="panel">
                <h2>üìã Order Submission</h2>
                
                <div class="form-group">
                    <label>Token Pair</label>
                    <select id="tokenIn">
                        <option value="So11111111111111111111111111111111111111112">SOL (Solana)</option>
                        <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
                    </select>
                    <div style="text-align: center; margin: 10px 0; font-size: 1.2rem;">‚Üì</div>
                    <select id="tokenOut">
                        <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
                        <option value="So11111111111111111111111111111111111111112">SOL (Solana)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="amount" value="1.5" step="0.1" min="0.01">
                    <div class="quick-amounts">
                        <button onclick="setAmount(0.5)">0.5</button>
                        <button onclick="setAmount(1)">1.0</button>
                        <button onclick="setAmount(2)">2.0</button>
                        <button onclick="setAmount(5)">5.0</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Slippage (%)</label>
                    <input type="number" id="slippage" value="0.5" step="0.1" min="0.1" max="5">
                </div>

                <button class="btn-primary" onclick="submitOrder()" id="submitBtn">
                    üì§ Submit Single Order
                </button>

                <button class="btn-primary btn-concurrent" onclick="submitConcurrentOrders()" id="concurrentBtn">
                    üöÄ Submit 5 Concurrent Orders
                </button>

                <div style="margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px;">
                    <strong>üí° Demo Tip:</strong><br>
                    Click "Submit 5 Concurrent Orders" to demonstrate:<br>
                    ‚Ä¢ Parallel processing<br>
                    ‚Ä¢ WebSocket live updates<br>
                    ‚Ä¢ DEX routing decisions<br>
                    ‚Ä¢ Queue management<br>
                    ‚Ä¢ Retry mechanism
                </div>
            </div>

            <!-- Order Timeline -->
            <div class="panel">
                <h2>üìä Live Order Timeline</h2>
                <div class="order-timeline" id="orderTimeline">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        No orders yet. Submit an order to see live updates!
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Section -->
        <div class="bottom-section">
            <!-- DEX Routing Log -->
            <div class="panel">
                <h2>üîÑ DEX Routing Decisions</h2>
                <div class="console-log" id="dexLog">
                    <div style="color: #666;">Waiting for routing decisions...</div>
                </div>
            </div>

            <!-- System Console -->
            <div class="panel">
                <h2>üìü System Console</h2>
                <div class="console-log" id="systemLog">
                    <div style="color: #666;">System ready...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://dex-order-engine-7jt2.onrender.com';
        const orders = new Map();
        let totalOrdersCount = 0;
        let confirmedOrders = 0;
        let executionTimes = [];

        function setAmount(value) {
            document.getElementById('amount').value = value;
        }

        function logToConsole(type, message) {
            const systemLog = document.getElementById('systemLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-time">${new Date().toLocaleTimeString()}</span><span>${message}</span>`;
            systemLog.prepend(entry);
            
            // Keep only last 50 entries
            while (systemLog.children.length > 50) {
                systemLog.removeChild(systemLog.lastChild);
            }
        }

        function logDexRouting(orderId, dex, price, amountOut) {
            const dexLog = document.getElementById('dexLog');
            
            // Don't log if already logged for this order
            const existingLog = Array.from(dexLog.children).find(child => 
                child.textContent.includes(orderId)
            );
            if (existingLog) return;
            
            const entry = document.createElement('div');
            entry.className = 'log-entry log-success';
            const shortId = orderId.substring(0, 16);
            entry.innerHTML = `
                <span class="log-time">${new Date().toLocaleTimeString()}</span>
                <span>
                    <strong>${shortId}:</strong> 
                    Selected <strong style="color: #667eea">${dex.toUpperCase()}</strong> 
                    ${price > 0 ? `| Price: ${price.toFixed(2)}` : ''} 
                    ${amountOut > 0 ? `| Est. Output: ${amountOut.toFixed(2)}` : ''}
                </span>
            `;
            dexLog.prepend(entry);
            
            // Add visual feedback
            entry.style.animation = 'slideIn 0.3s ease-out';
            
            while (dexLog.children.length > 30) {
                dexLog.removeChild(dexLog.lastChild);
            }
        }

        function updateStatistics() {
            document.getElementById('totalOrders').textContent = totalOrdersCount;
            const successRate = totalOrdersCount > 0 ? ((confirmedOrders / totalOrdersCount) * 100).toFixed(1) : 100;
            document.getElementById('successRate').textContent = successRate + '%';
            
            const avgTime = executionTimes.length > 0 
                ? (executionTimes.reduce((a, b) => a + b, 0) / executionTimes.length).toFixed(2)
                : '0.0';
            document.getElementById('avgExecTime').textContent = avgTime + 's';
            
            const active = Array.from(orders.values()).filter(o => !['confirmed', 'failed'].includes(o.status)).length;
            document.getElementById('activeOrders').textContent = active;
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = `order-card ${order.status}`;
            card.id = `order-${order.id}`;
            
            const stages = ['pending', 'routing', 'building', 'submitted', 'confirmed', 'failed'];
            const currentStageIndex = stages.indexOf(order.status);
            
            card.innerHTML = `
                <div class="order-header">
                    <div class="order-id">${order.id}</div>
                    <div class="order-status status-${order.status}">${order.status}</div>
                </div>
                <div class="order-stages">
                    ${stages.slice(0, 5).map((stage, i) => {
                        let className = 'stage';
                        if (i < currentStageIndex) className += ' completed';
                        if (i === currentStageIndex && order.status !== 'failed') className += ' active';
                        return `<div class="${className}"></div>`;
                    }).join('')}
                </div>
                <div class="order-details">
                    <div class="detail-item">Amount: <span class="detail-value">${order.amount}</span></div>
                    <div class="detail-item">Slippage: <span class="detail-value">${order.slippage}%</span></div>
                    ${order.dex ? `<div class="detail-item">DEX: <span class="detail-value">${order.dex}</span></div>` : ''}
                    ${order.executedPrice ? `<div class="detail-item">Price: <span class="detail-value">${order.executedPrice}</span></div>` : ''}
                    ${order.actualAmountOut ? `<div class="detail-item">Output: <span class="detail-value">${order.actualAmountOut}</span></div>` : ''}
                    ${order.txHash ? `<div class="detail-item" style="grid-column: 1 / -1;">TX: <span class="detail-value" style="font-size: 0.8rem;">${order.txHash.substring(0, 20)}...</span></div>` : ''}
                </div>
            `;
            
            return card;
        }

        function updateOrderCard(order) {
            const timeline = document.getElementById('orderTimeline');
            let card = document.getElementById(`order-${order.id}`);
            
            if (!card) {
                card = createOrderCard(order);
                timeline.prepend(card);
            } else {
                const newCard = createOrderCard(order);
                card.replaceWith(newCard);
            }
        }

        async function submitOrder() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Submitting...';
            
            try {
                const response = await fetch(`${API_URL}/api/orders/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tokenIn: document.getElementById('tokenIn').value,
                        tokenOut: document.getElementById('tokenOut').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        slippage: parseFloat(document.getElementById('slippage').value)
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    totalOrdersCount++;
                    const order = {
                        id: data.orderId,
                        status: 'pending',
                        amount: document.getElementById('amount').value,
                        slippage: document.getElementById('slippage').value
                    };
                    orders.set(data.orderId, order);
                    updateOrderCard(order);
                    updateStatistics();
                    
                    logToConsole('success', `Order ${data.orderId} submitted successfully`);
                    
                    // Poll for status
                    pollOrderStatus(data.orderId);
                } else {
                    logToConsole('error', `Failed to submit order: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                logToConsole('error', `Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üì§ Submit Single Order';
            }
        }

        async function submitConcurrentOrders() {
            const btn = document.getElementById('concurrentBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Submitting 5 orders...';
            
            logToConsole('info', 'üöÄ Starting concurrent order submission...');
            
            const amounts = [1.5, 2.0, 1.0, 2.5, 3.0];
            const promises = [];
            
            for (let i = 0; i < 5; i++) {
                const promise = fetch(`${API_URL}/api/orders/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tokenIn: 'So11111111111111111111111111111111111111112',
                        tokenOut: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
                        amount: amounts[i],
                        slippage: 0.5
                    })
                }).then(r => r.json());
                
                promises.push(promise);
            }
            
            try {
                const results = await Promise.all(promises);
                
                results.forEach((data, index) => {
                    if (data.orderId) {
                        totalOrdersCount++;
                        const order = {
                            id: data.orderId,
                            status: 'pending',
                            amount: amounts[index],
                            slippage: 0.5
                        };
                        orders.set(data.orderId, order);
                        updateOrderCard(order);
                        pollOrderStatus(data.orderId);
                    }
                });
                
                updateStatistics();
                logToConsole('success', `‚úÖ Successfully submitted ${results.length} concurrent orders`);
                
            } catch (error) {
                logToConsole('error', `Error in concurrent submission: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Submit 5 Concurrent Orders';
            }
        }

        async function pollOrderStatus(orderId) {
            const maxAttempts = 30;
            let attempts = 0;
            
            const poll = async () => {
                try {
                    const response = await fetch(`${API_URL}/api/orders/${orderId}`);
                    const data = await response.json();
                    
                    // Debug: Log the response
                    console.log(`[DEBUG] Order ${orderId} response:`, data.order);
                    
                    if (data.order) {
                        const order = orders.get(orderId) || {};
                        const prevStatus = order.status;
                        const prevDexLogged = order.dexLogged || false;
                        
                        Object.assign(order, {
                            id: orderId,
                            status: data.order.status,
                            amount: data.order.amount,
                            slippage: data.order.slippage,
                            dex: data.order.dex || order.dex,
                            executedPrice: data.order.executedPrice || order.executedPrice,
                            actualAmountOut: data.order.actualAmountOut || order.actualAmountOut,
                            txHash: data.order.txHash || order.txHash,
                            selectedPrice: data.order.selectedPrice || order.selectedPrice,
                            amountOut: data.order.amountOut || order.amountOut
                        });
                        
                        orders.set(orderId, order);
                        updateOrderCard(order);
                        
                        if (prevStatus !== order.status) {
                            logToConsole('info', `${orderId}: ${prevStatus} ‚Üí ${order.status}`);
                            
                            // Debug log
                            console.log(`[DEBUG] Status changed to ${order.status}, DEX: ${data.order.dex}, prevLogged: ${prevDexLogged}`);
                            
                            // Log DEX routing decision when status changes to routing
                            if (order.status === 'routing' && data.order.dex) {
                                console.log(`[DEBUG] Logging DEX routing for ${orderId}`);
                                logDexRouting(orderId, data.order.dex, data.order.selectedPrice || 0, data.order.amountOut || 0);
                                order.dexLogged = true;
                            }
                            
                            // Also log when building (DEX already selected)
                            if (order.status === 'building' && order.dex) {
                                console.log(`[DEBUG] Logging DEX routing at building stage for ${orderId}`);
                                logDexRouting(orderId, order.dex, order.executedPrice || data.order.selectedPrice || 0, order.actualAmountOut || data.order.amountOut || 0);
                                order.dexLogged = true;
                            }
                        }
                        
                        // Log DEX routing even if status didn't change but DEX info arrived
                        if ((order.status === 'routing' || order.status === 'building') && data.order.dex && !prevDexLogged) {
                            console.log(`[DEBUG] Late DEX info arrival for ${orderId}, logging now`);
                            logDexRouting(orderId, data.order.dex, data.order.selectedPrice || data.order.executedPrice || 0, data.order.amountOut || data.order.actualAmountOut || 0);
                            order.dexLogged = true;
                            orders.set(orderId, order);
                        }
                        
                        // Log DEX routing even if status didn't change but DEX info arrived
                        if (order.status === 'routing' && data.order.dex && !prevDexLogged) {
                            logDexRouting(orderId, data.order.dex, data.order.selectedPrice || 0, data.order.amountOut || 0);
                            order.dexLogged = true;
                        }
                        
                        // Always log DEX decision when we first see DEX info
                        if (order.dex && !order.dexLogged) {
                            console.log(`[DEBUG] Found DEX info, logging: ${order.dex}`);
                            logDexRouting(orderId, order.dex, order.executedPrice || order.selectedPrice || 0, order.actualAmountOut || order.amountOut || 0);
                            order.dexLogged = true;
                            orders.set(orderId, order);
                        }
                        
                        if (order.status === 'confirmed') {
                            confirmedOrders++;
                            if (data.order.createdAt && data.order.completedAt) {
                                const execTime = (new Date(data.order.completedAt) - new Date(data.order.createdAt)) / 1000;
                                executionTimes.push(execTime);
                            }
                            updateStatistics();
                            logToConsole('success', `‚úÖ ${orderId} confirmed! TX: ${order.txHash?.substring(0, 16)}...`);
                            return;
                        }
                        
                        if (order.status === 'failed') {
                            updateStatistics();
                            logToConsole('error', `‚ùå ${orderId} failed`);
                            return;
                        }
                        
                        updateStatistics();
                    }
                    
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(poll, 1000);
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            };
            
            poll();
        }

        // Initialize
        logToConsole('success', 'Demo dashboard initialized');
        logToConsole('info', 'Ready to process orders');
    </script>
</body>
</html>
